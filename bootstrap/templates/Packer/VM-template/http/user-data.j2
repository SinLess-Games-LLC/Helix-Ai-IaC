#cloud-config
#
# Cloud Init user-data config.
# Do not alter first line of this file.
# https://cloudinit.readthedocs.io/en/latest/
autoinstall:
  version: 1
  locale: en_US
  keyboard:
    layout: us
  ssh:
    install-server: true
    allow-pw: true
    disable_root: true
    ssh_quiet_keygen: true
    allow_public_ssh_keys: true
  identity:
    hostname: "ubuntu"
    username: "#{ template.ssh.username }#"
    password: "#{ template.ssh.password.encrypted }#"
  storage:
    layout:
      name: direct
    swap:
      size: 0
  user-data:
    package_upgrade: false
    disable_root: true
    timezone: #{ system.timezone }#
    users:
      - name: #{ template.ssh.username }#
        groups:
          - adm
          - sudo
        lock-passwd: false
        sudo: ALL=(ALL) NOPASSWD:ALL
        shell: /bin/bash
        ssh_authorized_keys:
          #% for item in template.ssh.authorized_keys %#
          - #{ item }#
          #% endfor %#
  late-commands:
    - sed -i -e 's/^#\?PasswordAuthentication.*/PasswordAuthentication #{ template.ssh.password.authentication|lower }#/g' /target/etc/ssh/sshd_config
    - sed -i -e 's/^#\?PermitRootLogin.*/PermitRootLogin #{ template.root_login }#/g' /target/etc/ssh/sshd_config
    - echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/ubuntu
    - curtin in-target --target=/target -- chmod 440 /etc/sudoers.d/ubuntu
    - curtin in-target --target=/target -- apt-get update
    - curtin in-target --target=/target -- apt-get upgrade --yes
    - curtin in-target --target=/target -- apt-get install --yes openssh-server sudo qemu-guest-agent wget zsh curl software-properties-common python3 python3-pip net-tools git
